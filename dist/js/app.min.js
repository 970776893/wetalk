var dependencies=["ngAnimate","ngRoute","ngCookies","ngTouch","ngSanitize","ui.bootstrap"],app=angular.module("app",dependencies);app.run(function($rootScope,$cookies){$rootScope.login=function(){var loginUser={id:1e4,name:"张凯",imgUrl:"./app/displaydata/imgs/zhangkai.png"};return $cookies.putObject("loginUser",loginUser),loginUser},$rootScope.loginUser=$rootScope.login()}),app.run(function($rootScope,$route){$rootScope.$on("$locationChangeSuccess",function(event,newUrl,oldUrl){$rootScope.url=window.location.hash;var className="we"+$route.current.$$route.originalPath.toLocaleLowerCase();className.indexOf(":")>0&&(className=className.substring(0,className.indexOf(":")-1)),className=className.replace("/","-"),$rootScope.bodyClass=className}),document.addEventListener("touchmove",function(e){e.preventDefault()},!1)}),app.run(function($rootScope,$timeout){$rootScope.isTalkingUser=function(userId){var talkWindowUrl="#/talkWindow/",isTalkWindows=!1;if(-1!==window.location.hash.indexOf(talkWindowUrl)){var talkWindowId=Number(window.location.hash.substring(talkWindowUrl.length));userId===talkWindowId&&(isTalkWindows=!0)}return isTalkWindows},$rootScope.isWeiXin=function(){var ua=window.navigator.userAgent.toLowerCase();return"micromessenger"===ua.match(/MicroMessenger/i)?!0:!1},$rootScope.changeSectionHeight=function(){var sectionHeight=window.innerHeight-$("footer").outerHeight()-$("header").outerHeight()+"px";(void 0===$rootScope.sectionStyle||$rootScope.sectionStyle.height!==sectionHeight)&&($rootScope.sectionStyle={height:sectionHeight},$rootScope.isWeiXin()&&($("body")[0].scrollTop=0)),$timeout($rootScope.changeSectionHeight,300).then(function(){},function(){})},$rootScope.changeSectionHeight()}),app.run(function($rootScope,localStorageService){$rootScope.getMsg=function(userInfo,msgInfo){localStorageService.handlerReceiveMsg(userInfo,msgInfo),localStorageService.handlerRecentTalkList(userInfo);var isTalkWindows=$rootScope.isTalkingUser(userInfo.id);isTalkWindows?(null===$rootScope.talkingList&&($rootScope.talkingList=[]),$rootScope.talkingList.push(msgInfo)):($rootScope.refreshTalkList=!0,$rootScope.noreadNumTotal=$rootScope.noreadNumTotal+1)}}),app.run(function($rootScope,localStorageService){$rootScope.noreadNumTotal=localStorageService.getNoreadNumTotal()}),app.run(function($rootScope,weService){weService.getMsgToolsList().then(function(res){$rootScope.msgTools=[];for(var columns=4,line=[],i=0;i<res.data.length;i++)i%columns===0&&0!==i&&($rootScope.msgTools.push(line),line=[]),line.push(res.data[i]);line.length>0&&$rootScope.msgTools.push(line)})}),app.run(function($rootScope){$rootScope.emList={faceList:[]};for(var facePath="./imgs/face/",_suffix=".gif",startIndex=1,size=75,showColoum=6,showRow=3,lineFace=[],pageFace=[],index=startIndex;size+startIndex>index;index++){var face={code:index,path:facePath+index+_suffix};(index-startIndex)%showColoum===0&&index!==startIndex&&(pageFace.push(lineFace),lineFace=[],pageFace.length===showRow&&($rootScope.emList.faceList.push(pageFace),pageFace=[])),lineFace.push(face)}lineFace.length>0&&pageFace.push(lineFace),pageFace.length>0&&$rootScope.emList.faceList.push(pageFace),$rootScope.prevCarousel=function($event){$("#faceList").carousel("next")},$rootScope.nextCarousel=function($event){$("#faceList").carousel("prev")},$rootScope.addEm=function(em){var emCode="[em-"+em.code+"]";$rootScope.data.msgContent?$rootScope.data.msgContent+=emCode:$rootScope.data.msgContent=emCode}}),app.run(function($rootScope,$cookies,$timeout,dialog,weService){$rootScope.testGetMessageRondom=function(){var fromUserId=Math.floor(9*Math.random()+1);weService.getUserList().then(function(res){var fromUser,userList=res.data;angular.forEach(userList,function(user){return String(user.id)===String(fromUserId)?void(fromUser=user):void 0});var msgInfo={id:1,content:"测试-收到消息 ",time:(new Date).getTime(),sourceType:1,msgType:1};$rootScope.getMsg(fromUser,msgInfo)})},$rootScope.testGetMessageWindow=function(){var talkWindowUrl="#/talkWindow/";if(-1===window.location.hash.indexOf(talkWindowUrl))return void console.log("不是聊天窗口");var fromUserId=Number(window.location.hash.substring(talkWindowUrl.length));weService.getUserList().then(function(res){var fromUser,userList=res.data;angular.forEach(userList,function(user){return String(user.id)===String(fromUserId)?void(fromUser=user):void 0});var msgInfo={id:1,content:"测试-收到消息 ",time:(new Date).getTime(),sourceType:1,msgType:1};$rootScope.getMsg(fromUser,msgInfo)})},$rootScope.confirm=function(number){var title,btns=[];1===number?(title="祝您身体健康，万事如意！！",btns.push("确认")):(title="删除订单",btns.push("强制删除"),btns.push("删除"),btns.push("取消"));var instance=dialog.confirm(title,btns);instance.result.then(function(mark){console.log(mark),$rootScope.alerts.push({msg:mark})})},$rootScope.loading=function(){var instance=dialog.loading("加载中");$timeout(function(){instance.close(),$rootScope.alerts.push({msg:"加载成功"})},3e3)};var index=0;$rootScope.tip=function(){$rootScope.alerts.push({msg:"信息提示"+index}),index+=1},$rootScope.option=function(){var instance=dialog.options("请选择操作",["买入","卖出"],"取消");instance.result.then(function(mark){console.log(mark),$rootScope.alerts.push({msg:mark})})},$rootScope.alerts=[]}),app.factory("dialog",function($uibModal){return{confirm:function(msg,buttons){return $uibModal.open({animation:!0,templateUrl:"./app/modules/base/htmls/confirm.part.html",windowClass:"dialog-confirm",controller:function($scope,$uibModalInstance){$scope.msg=msg,$scope.buttons=buttons,$scope.ok=function(value){$uibModalInstance.close(value)}}})},loading:function(title){return $uibModal.open({animation:!0,size:"sm",windowClass:"dialog-loading",backdrop:!1,templateUrl:"./app/modules/base/htmls/loading.part.html",controller:function($scope,$uibModalInstance){$scope.title=title}})},options:function(title,options,cancel){return $uibModal.open({animation:!0,windowClass:"dialog-options",templateUrl:"./app/modules/base/htmls/options.part.html",controller:function($scope,$uibModalInstance){$scope.title=title,$scope.options=options,$scope.cancel=cancel||"Cancel",$scope.ok=function(value){$uibModalInstance.close(value)}}})}}}),app.config(function($httpProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/json;charset=utf-8"}),app.directive("weLayout",function(){return{restrict:"EA",templateUrl:"./app/modules/base/htmls/layout.part.html"}}),app.directive("weHeader",function(){return{restrict:"EA",replace:!0,templateUrl:"./app/modules/base/htmls/header.part.html"}}),app.directive("weFooter",function(){return{restrict:"EA",replace:!0,templateUrl:"./app/modules/base/htmls/footer.part.html"}}),app.directive("ngTouchstart",function(){return{controller:function($scope,$element,$attrs){function onTouchStart(event){var method=$element.attr("ng-touchstart");$scope.$event=event,$scope.$apply(method)}$element.bind("touchstart",onTouchStart)}}}),app.directive("ngTouchmove",function(){return{controller:function($scope,$element,$attrs){function onTouchStart(event){event.preventDefault(),$element.bind("touchmove",onTouchMove),$element.bind("touchend",onTouchEnd)}function onTouchMove(event){var method=$element.attr("ng-touchmove");$scope.$event=event,$scope.$apply(method)}function onTouchEnd(event){event.preventDefault(),$element.unbind("touchmove",onTouchMove),$element.unbind("touchend",onTouchEnd)}$element.bind("touchstart",onTouchStart)}}}),app.directive("ngTouchend",function(){return{controller:function($scope,$element,$attrs){function onTouchEnd(event){var method=$element.attr("ng-touchend");$scope.$event=event,$scope.$apply(method)}$element.bind("touchend",onTouchEnd)}}}),app.directive("focusable",function(){return{restrict:"A",scope:{focusable:"="},link:function(scope,elm,attrs){scope.$watch("focusable",function(value){value&&setTimeout(function(){elm[0].focus()},0)})}}}),app.filter("userStatusFilter",function($rootScope){return function(input){var label=$rootScope.i18n.user,status=Number(input);return 0===status?label.statusNormal:1===status?label.statusFrozen:$rootScope.i18n["public"].unKnow}}),app.config(function($routeProvider){$routeProvider.when("/userList",{templateUrl:"./app/modules/user/htmls/user_list.html",controller:"userListController"}).when("/talkList",{templateUrl:"./app/modules/talk/htmls/talk_list.html",controller:"talkListController"}).when("/talkWindow/:id",{templateUrl:"./app/modules/talk/htmls/talk_window.html",controller:"talkWindowController"}).otherwise({templateUrl:"./app/modules/base/htmls/unknow.part.html",controller:function($rootScope,$scope){$rootScope.bodyClass="error-page"}})}),app.service("weService",function($http){return{getUserList:function(){return $http({url:"./app/displaydata/userlist.json",method:"get",dataType:"json"})},getMsgToolsList:function(){return $http({url:"./app/modules/base/data/messageTools.json",method:"get",dataType:"json"})}}}),app.service("localStorageService",function($rootScope,$http,$cookies){return{getRecentTalkList:function(){var loginUser=$cookies.getObject("loginUser"),storage=window.localStorage,recentUsers=[];if(storage){var key=loginUser.id+"_recent_users";recentUsers=storage.getItem(key),recentUsers=null===recentUsers?[]:JSON.parse(recentUsers),angular.forEach(recentUsers,function(rUser){var iKey=loginUser.id+"_history_"+rUser.userId,historyList=storage.getItem(iKey);if(null!==historyList){historyList=JSON.parse(historyList);var lastmsg=historyList[0];rUser.lastMsgContent=lastmsg.content,rUser.lastMsgTime=lastmsg.time;for(var noReadNum=0,i=0;i<historyList.length;i++){var historyItem=historyList[i];if(1===historyItem.sourceType){if(historyItem.isRead)break;noReadNum++}}rUser.noReadNum=noReadNum}})}else console.log("不支持本地存储");return recentUsers},getRecentMsgList:function(userId,pageNo,pageSize){var historyList,loginUser=$cookies.getObject("loginUser"),storage=window.localStorage;if(storage){var hKey=loginUser.id+"_history_"+userId;historyList=storage.getItem(hKey),historyList=null!==historyList?JSON.parse(historyList):[];for(var i=0;i<historyList.length;i++){var historyItem=historyList[i];if(1!==historyItem.sourceType||historyItem.isRead){if(historyItem.isRead)break}else historyItem.isRead=!0,$rootScope.noreadNumTotal=$rootScope.noreadNumTotal-1}storage.setItem(hKey,JSON.stringify(historyList)),historyList=historyList.slice((pageNo-1)*pageSize,pageNo*pageSize)}else console.log("不支持本地存储");return historyList},handlerReceiveMsg:function(userInfo,msgInfo){var loginUser=$cookies.getObject("loginUser"),storage=window.localStorage;if(storage){var hKey=loginUser.id+"_history_"+userInfo.id,historyList=storage.getItem(hKey);historyList=null===historyList?[]:JSON.parse(historyList),100===historyList.length&&historyList.pop();var isTalkWindows=$rootScope.isTalkingUser(userInfo.id);msgInfo.time=(new Date).getTime(),msgInfo.status=0,msgInfo.isRead=isTalkWindows,historyList.unshift(msgInfo),storage.setItem(hKey,JSON.stringify(historyList))}else console.log("不支持本地存储")},handlerSendMsg:function(userInfo,msgInfo){var loginUser=$cookies.getObject("loginUser"),storage=window.localStorage;if(storage){var hKey=loginUser.id+"_history_"+userInfo.id,historyList=storage.getItem(hKey);historyList=null===historyList?[]:JSON.parse(historyList),historyList.unshift(msgInfo),storage.setItem(hKey,JSON.stringify(historyList))}else console.log("不支持本地存储")},handlerRecentTalkList:function(userInfo){var loginUser=$cookies.getObject("loginUser"),storage=window.localStorage;if(storage){var key=loginUser.id+"_recent_users",recentUsers=storage.getItem(key);recentUsers=null===recentUsers?[]:JSON.parse(recentUsers);for(var index=-1,i=0;i<recentUsers.length;i++){var rUser=recentUsers[i];if(String(rUser.userId)===String(userInfo.id)){index=i;break}}index>0&&recentUsers.splice(index,1),0!==index&&recentUsers.unshift({userId:userInfo.id,userName:userInfo.name,userImgUrl:userInfo.imgUrl}),storage.setItem(key,JSON.stringify(recentUsers))}else console.log("不支持本地存储")},getNoreadNumTotal:function(){var total=0,loginUser=$cookies.getObject("loginUser"),storage=window.localStorage,recentUsers=[];if(storage){var key=loginUser.id+"_recent_users";if(recentUsers=storage.getItem(key),null===recentUsers)return total;recentUsers=JSON.parse(recentUsers),angular.forEach(recentUsers,function(rUser){var iKey=loginUser.id+"_history_"+rUser.userId,historyList=storage.getItem(iKey);if(null!==historyList){historyList=JSON.parse(historyList);var lastmsg=historyList[0];rUser.lastMsgContent=lastmsg.content,rUser.lastMsgTime=lastmsg.time;for(var noReadNum=0,i=0;i<historyList.length;i++){var historyItem=historyList[i];if(1===historyItem.sourceType){if(historyItem.isRead)break;noReadNum++}}total+=noReadNum}})}else console.log("不支持本地存储");return total},deleteUserHistory:function(userId){var loginUser=$cookies.getObject("loginUser"),storage=window.localStorage,recentUsers=[];if(storage){var key=loginUser.id+"_recent_users";if(recentUsers=storage.getItem(key),null===recentUsers)return;recentUsers=JSON.parse(recentUsers);for(var index=0;index<recentUsers.length&&String(recentUsers[index].userId)!==String(userId);index++);recentUsers.splice(index,1),storage.setItem(key,JSON.stringify(recentUsers));var iKey=loginUser.id+"_history_"+userId;storage.removeItem(iKey)}else console.log("不支持本地存储")}}}),app.controller("talkListController",function($rootScope,$scope,$location,dialog,$timeout,localStorageService){$rootScope.title="消息",$scope.getTalkList=function(){$scope.talkList=localStorageService.getRecentTalkList(),$scope.talkListOrg=$scope.talkList,$rootScope.refreshTalkList=!1},$scope.getTalkList(),$scope.talk=function(talkItem){$location.path("/talkWindow/"+talkItem.userId)},$rootScope.$watch("refreshTalkList",function(newValue,oldValue,scope){console.log(newValue),newValue&&$scope.getTalkList()}),$scope.queryByKey=function(){$scope.talkList=[],angular.forEach($scope.talkListOrg,function(item){(-1!==item.userName.indexOf($scope.queryData)||-1!==String(item.lastMsgContent).indexOf($scope.queryData))&&$scope.talkList.push(item)})},$scope.queryByKeyBLur=function(){$scope.talkList=$scope.talkListOrg,$scope.queryData=null},$scope.optHistory=function(item){for(var index=0;index<$scope.talkList.length&&String($scope.talkList[index].userId)!==String(item.userId);index++);$scope.showOptIndex=index},$scope.hiddenOpt=function(){$scope.showOptIndex=-1},$scope["delete"]=function(item,$event){dialog.confirm("确定删除【"+item.userName+"】的聊天",["删除","取消"]).result.then(function(res){"删除"===res&&(localStorageService.deleteUserHistory(item.userId),$scope.getTalkList(),$rootScope.noreadNumTotal=$rootScope.noreadNumTotal-item.noReadNum,$scope.showOptIndex=-1,$($event.target).parent().removeClass("show-opt-wapper"))})},$scope.myScroll=new iScroll("wrapper-talklist",{useTransition:!0,checkDOMChanges:!0,hScroll:!1,onScrollMove:function(){this.y<10&&($scope.tip="下拉刷新"),this.y>10&&($scope.tipShow=!0,$scope.tip="释放刷新")},onBeforeScrollStart:function(e){},onScrollEnd:function(){$scope.tipShow&&($scope.tip="刷新中...",setTimeout(function(){$scope.tipShow=!1,$scope.getTalkList()},2e3))}})}),app.controller("talkWindowController",function($rootScope,$scope,$location,$routeParams,$cookies,$timeout,popup,weService,localStorageService){var userId=String($routeParams.id);weService.getUserList().then(function(res){angular.forEach(res.data,function(user){String(user.id)===userId&&($scope.userInfo=user,$rootScope.title=$scope.userInfo.name)})}),$scope.loginUser=$cookies.getObject("loginUser"),$scope.pageNo=1,$scope.pageSize=3,$rootScope.talkingList=localStorageService.getRecentMsgList(userId,$scope.pageNo,$scope.pageSize),$scope.replaceEm=function(str){return str=str.replace(/</g,"&lt;"),str=str.replace(/>/g,"&gt;"),str=str.replace(/\n/g,"<br/>"),str=str.replace(/\[em-([0-9]*)\]/g,'<img src="./imgs/face/$1.gif"  border="0"/>')},$rootScope.data={},$scope.sendMsg=function(){var inputContent=$rootScope.data.msgContent;if(inputContent){$scope.sending=!0;var msgInfo={id:1,content:inputContent,status:Math.random()>.5?0:1,time:(new Date).getTime(),sourceType:2,msgType:1};$rootScope.talkingList.push(msgInfo),$rootScope.data.msgContent=null,localStorageService.handlerSendMsg($scope.userInfo,msgInfo),localStorageService.handlerRecentTalkList($scope.userInfo)}},$scope.sounding=function(item){$("audio")[0].src=item.src,$("audio")[0].play()},$rootScope.sendMsgByKeyup=function(event){13===event.keyCode&&$scope.sendMsg()},$rootScope.sendMsgByButton=function(){$scope.sendMsg()},$rootScope.focusInput=function(){$rootScope.msgInputFocus=!1,$rootScope.showTools=0},$scope.$watch("talkingList",function(newValue,oldValue,scope){$timeout(function(){if($scope.myScroll.refresh(),$scope.myScroll.maxScrollY<0){var targetHtml=$(".talk-window-item:last");$scope.myScroll.scrollToElement(targetHtml[0],200)}})},!0),$scope.$watch("sectionStyle",function(newValue,oldValue,scope){$timeout(function(){$scope.myScroll.refresh();var targetHtml=$(".talk-window-item:last");targetHtml.length>0&&$scope.myScroll.scrollToElement(targetHtml[0],0)})}),$rootScope.handMsgTools=function(tools,$event){console.log("不支持类型:"+tools.text)},$rootScope.startRecordVoice=function(){$rootScope.strart4Voice=new Date},$rootScope.sendMsg4Voice=function(){if(null!==$rootScope.strart4Voice){var lengthInSecond=((new Date).getTime()-$rootScope.strart4Voice.getTime())/1e3;if(.5>lengthInSecond)return void console.log("录制时间太短:"+lengthInSecond+"s");var msgInfo={id:1,status:Math.random()>.5?0:1,time:(new Date).getTime(),src:"./app/displaydata/test.mp3",lengthInSecond:lengthInSecond.toFixed(2),sourceType:2,msgType:2};$rootScope.talkingList.push(msgInfo),localStorageService.handlerSendMsg($scope.userInfo,msgInfo),localStorageService.handlerRecentTalkList($scope.userInfo),console.log("发送语音:"+lengthInSecond+"s"),$rootScope.strart4Voice=null}},$scope.reSendMsg=function(item){popup.confim("消息重发","点击<strong>确定</strong>重新发送该消息").then(function(res){var msgInfo=angular.copy(item);msgInfo.status=0,msgInfo.time=(new Date).getTime(),$rootScope.talkingList.push(msgInfo),localStorageService.handlerSendMsg($scope.userInfo,msgInfo),localStorageService.handlerRecentTalkList($scope.userInfo)})},$scope.myScroll=new iScroll("wrapper-talkwindow",{useTransition:!0,checkDOMChanges:!0,hScroll:!1,onScrollMove:function(){this.y<10&&($scope.tip="下拉刷新"),this.y>10&&($scope.tipShow=!0,$scope.tip="释放刷新")},onBeforeScrollStart:function(e){},onScrollEnd:function(){$scope.tipShow&&($scope.tip="刷新中...",setTimeout(function(){$scope.pageNo=$scope.pageNo+1;var result=localStorageService.getRecentMsgList(userId,$scope.pageNo,$scope.pageSize);$rootScope.talkingList=$rootScope.talkingList.concat(result),$scope.tip="刷新成功",$scope.tipShow=!1},1e3))}})}),app.controller("userListController",function($rootScope,$scope,$location,$timeout,weService){$rootScope.title="通讯录",$scope.getUserList=function(){$scope.userList=[],weService.getUserList().then(function(res){$scope.userListOrg=res.data,$scope.userList=res.data,$scope.queryKeyList=[],angular.forEach($scope.userList,function(user){var queryKey=user.initial,flag=!0;angular.forEach($scope.queryKeyList,function(qk){return qk===queryKey?void(flag=!1):void 0}),flag&&$scope.queryKeyList.push(queryKey)})})},$scope.getUserList(),$scope.talk=function(user){$location.path("/talkWindow/"+user.id)},$scope.queryByinitial=function($event){for(var initials=$($event.target).parent().children(),potionY=$event.originalEvent.touches[0].pageY,index=0;index<initials.length;index++){var top=$(initials[index]).offset().top,height=$(initials[index]).height();if(potionY>top&&top+height>=potionY)break}if(index!==initials.length){var key=$(initials[index]).text(),targetHtml=$("SUB:contains("+key+")").parent().parent().parent()[0];$scope.myScroll.scrollToElement(targetHtml,300)}},$scope.queryByKey=function(){$scope.userList=[],angular.forEach($scope.userListOrg,function(user){-1!==user.name.indexOf($scope.queryData)&&$scope.userList.push(user)})},$scope.queryByKeyBLur=function(){$scope.userList=$scope.userListOrg,$scope.queryData=null},$scope.showOpt=function(item){for(var index=0;index<$scope.userList.length&&String($scope.userList[index].id)!==String(item.id);index++);$scope.showOptIndex=index},$scope.hiddenOpt=function(){$scope.showOptIndex=void 0},$scope.myScroll=new iScroll("wrapper-userlist",{useTransition:!0,checkDOMChanges:!0,hScroll:!1,onScrollMove:function(){this.y<10&&($scope.tip="下拉刷新"),this.y>10&&($scope.tipShow=!0,$scope.tip="释放刷新")},onBeforeScrollStart:function(e){},onScrollEnd:function(){$scope.tipShow&&($scope.tip="刷新中...",setTimeout(function(){$scope.getUserList(),$scope.tipShow=!1},2e3))}})});