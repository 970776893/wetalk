var dependencies=["ngAnimate","ngRoute","ngCookies","ngTouch"],app=angular.module("app",dependencies);app.run(function(a){a.$on("$locationChangeSuccess",function(b,c,d){a.url=window.location.hash;var e="we-"+c.substring(c.indexOf("#")+2).toLocaleLowerCase();if(e.indexOf("/")>0&&(e=e.substring(0,e.indexOf("/"))),$("body").addClass(e),c!==d){var f="we-"+d.substring(d.indexOf("#")+2).toLocaleLowerCase();f.indexOf("/")>0&&(f=f.substring(0,f.indexOf("/"))),$("body").removeClass(f)}})}),app.run(function(a){a.isTalkingUser=function(a){var b="#/talkWindow/",c=!1;if(-1!==window.location.hash.indexOf(b)){var d=Number(window.location.hash.substring(b.length));a===d&&(c=!0)}return c}}),app.run(function(a,b){a.getMsg=function(c,d){b.handlerReceiveMsg(c,d),b.handlerRecentTalkList(c);var e=a.isTalkingUser(c.id);e&&a.talkingList.push(d)}}),app.run(function(a){var b={id:1e4,name:"张凯",imgUrl:"/app/displaydata/imgs/zhangkai.png"};a.putObject("loginUser",b)}),app.factory("popup",function(a){return{confim:function(b,c){return a.open({animation:!0,templateUrl:"/app/modules/base/htmls/confim.part.html",controller:function(a,d){a.title=b,a.msg=c,a.ok=function(){d.close("ok")},a.cancel=function(){d.dismiss("cancel")}}})}}}),app.config(function(a){a.defaults.headers.post["Content-Type"]="application/json;charset=utf-8"}),app.directive("weLayout",function(){return{restrict:"EA",templateUrl:"/app/modules/base/htmls/layout.part.html"}}),app.directive("ngTouchstart",function(){return{controller:function(a,b,c){function d(c){var d=b.attr("ng-touchstart");a.$event=c,a.$apply(d)}b.bind("touchstart",d)}}}),app.directive("ngTouchmove",function(){return{controller:function(a,b,c){function d(a){a.preventDefault(),b.bind("touchmove",e),b.bind("touchend",f)}function e(c){var d=b.attr("ng-touchmove");a.$event=c,a.$apply(d)}function f(a){a.preventDefault(),b.unbind("touchmove",e),b.unbind("touchend",f)}b.bind("touchstart",d)}}}),app.directive("ngTouchend",function(){return{controller:function(a,b,c){function d(c){var d=b.attr("ng-touchend");a.$event=c,a.$apply(d)}b.bind("touchend",d)}}}),app.directive("focusable",function(){return{restrict:"A",scope:{focusable:"="},link:function(a,b,c){a.$watch("focusable",function(a){a&&setTimeout(function(){b[0].focus()},0)})}}}),app.filter("userStatusFilter",function(a){return function(b){var c=a.i18n.user,d=Number(b);return 0===d?c.statusNormal:1===d?c.statusFrozen:a.i18n["public"].unKnow}}),app.config(function(a){a.when("/userList",{templateUrl:"/app/modules/user/htmls/user_list.html",controller:"userListController"}).when("/talkList",{templateUrl:"/app/modules/talk/htmls/talk_list.html",controller:"talkListController"}).when("/talkWindow/:id",{templateUrl:"/app/modules/talk/htmls/talk_window.html",controller:"talkWindowController"}).otherwise({templateUrl:"/app/modules/base/htmls/unknow.part.html"})}),app.service("weService",function(a){return{getUserList:function(){return a({url:"/app/displaydata/userlist.json",method:"get",dataType:"json"})}}}),app.service("localStorageService",function(a,b,c){return{getRecentTalkList:function(){var a=c.getObject("loginUser"),b=window.localStorage,d=[];if(b){var e=a.id+"_recent_users";d=b.getItem(e),d=null===d?[]:JSON.parse(d),angular.forEach(d,function(c){var d=a.id+"_history_"+c.userId,e=b.getItem(d);if(null!=e){e=JSON.parse(e);var f=e[e.length-1];c.lastMsgContent=f.content,c.lastMsgTime=f.time;for(var g=0,h=0;h<e.length;h++){var i=e[h];if(1===i.sourceType){if(i.isRead)break;g++}}c.noReadNum=g}})}else console.log("不支持本地存储");return d},getRecentMsgList:function(a){var b,d=c.getObject("loginUser"),e=window.localStorage;if(e){var f=d.id+"_history_"+a;b=e.getItem(f),b=null!==b?JSON.parse(b):[];for(var g=0;g<b.length;g++){var h=b[g];1===h.sourceType&&(h.isRead=!0)}e.setItem(f,JSON.stringify(b))}else console.log("不支持本地存储");return b},handlerReceiveMsg:function(b,d){var e=c.getObject("loginUser"),f=window.localStorage;if(f){var g=e.id+"_history_"+b.id,h=f.getItem(g);h=null===h?[]:JSON.parse(h),100===h.length&&h.pop();var i=a.isTalkingUser(b.id);h.push({id:d.id,content:d.content,time:(new Date).getTime(),sourceType:1,msgType:d.Type,isRead:i}),f.setItem(g,JSON.stringify(h))}else console.log("不支持本地存储")},handlerSendMsg:function(a,b){var d=c.getObject("loginUser"),e=window.localStorage;if(e){var f=d.id+"_history_"+a.id,g=e.getItem(f);g=null===g?[]:JSON.parse(g),g.push(b),e.setItem(f,JSON.stringify(g))}else console.log("不支持本地存储")},handlerRecentTalkList:function(a){var b=c.getObject("loginUser"),d=window.localStorage;if(d){var e=b.id+"_recent_users",f=d.getItem(e);f=null===f?[]:JSON.parse(f);for(var g=-1,h=0;h<f.length;h++){var i=f[h];if(String(i.userId)===String(a.id)){g=h;break}}g>0&&f.splice(g,1),0!==g&&f.unshift({userId:a.id,userName:a.name,userImgUrl:a.imgUrl}),d.setItem(e,JSON.stringify(f))}else console.log("不支持本地存储")}}}),app.controller("talkListController",function(a,b,c,d){a.title="消息",b.talkList=d.getRecentTalkList();var e=new Date;angular.forEach(b.talkList,function(a){var b=new Date(a.lastMsgTime);e.getFullYear()===b.getFullYear()&&e.getMonth()===b.getMonth()&&e.getDate()===b.getDate()&&(a.isToday=!0)}),b.talk=function(a){c.path("/talkWindow/"+a.userId)}}),app.controller("talkWindowController",function(a,b,c,d,e,f,g){var h=String(d.id);f.getUserList().then(function(c){angular.forEach(c.data,function(c){String(c.id)===h&&(b.userInfo=c,a.title=b.userInfo.name)})}),b.loginUser=e.getObject("loginUser"),a.talkingList=g.getRecentMsgList(h),b.sendMsg=function(){var c=$("#msgInput").val();if(c){b.sending=!0;var d={id:1,content:c,time:(new Date).getTime(),sourceType:2,msgType:1};a.talkingList.push(d),$("#msgInput").val(null),g.handlerSendMsg(b.userInfo,d),g.handlerRecentTalkList(b.userInfo)}},a.sendMsgByKeyup=function(a){13===a.keyCode&&b.sendMsg()},a.sendMsgByButton=function(){a.msgInputFocus=!0,b.sendMsg()},a.$watch("talkingList",function(a,b,c){console.log($("table").scrollTop()),$(document).scrollTop(1e8)},!0)}),app.controller("userListController",function(a,b,c,d){a.title="通讯录",d.getUserList().then(function(a){b.userListOrg=a.data,b.userList=a.data,b.queryKeyList=[],angular.forEach(b.userList,function(a){var c=a.initial,d=!0;angular.forEach(b.queryKeyList,function(a){return a===c?void(d=!1):void 0}),d&&b.queryKeyList.push(c)})}),b.talk=function(a){c.path("/talkWindow/"+a.id)},b.queryByinitial=function(a){console.log(a)},b.queryByKey=function(){b.userList=[],angular.forEach(b.userListOrg,function(a){-1!==a.name.indexOf(b.queryData)&&b.userList.push(a)})},b.queryByKeyBLur=function(){b.userList=b.userListOrg,b.queryData=null},b.queryByKeyFocus=function(){b.userList=[]}});