var dependencies=["ngAnimate","ngRoute","ngCookies","ngTouch"],app=angular.module("app",dependencies);app.run(function(a,b){a.login=function(){var a={id:1e4,name:"张凯",imgUrl:"/app/displaydata/imgs/zhangkai.png"};return b.putObject("loginUser",a),a},a.loginUser=a.login()}),app.run(function(a,b){a.$on("$locationChangeSuccess",function(c,d,e){a.url=window.location.hash;var f="we"+b.current.$$route.originalPath.toLocaleLowerCase();f.indexOf(":")>0&&(f=f.substring(0,f.indexOf(":")-1)),f=f.replace("/","-"),a.bodyClass=f})}),app.run(function(a){a.isTalkingUser=function(a){var b="#/talkWindow/",c=!1;if(-1!==window.location.hash.indexOf(b)){var d=Number(window.location.hash.substring(b.length));a===d&&(c=!0)}return c},a.changeSectionHeight=function(){var b=window.innerHeight-102+"px";a.sectionStyle={"max-height":b}},a.changeSectionHeight()}),app.run(function(a,b){a.getMsg=function(c,d){b.handlerReceiveMsg(c,d),b.handlerRecentTalkList(c);var e=a.isTalkingUser(c.id);e?(null==a.talkingList&&(a.talkingList=[]),a.talkingList.push(d)):(a.refreshTalkList=!0,a.noreadNumTotal=a.noreadNumTotal+1)}}),app.run(function(a,b){a.noreadNumTotal=b.getNoreadNumTotal()}),app.run(function(a,b){b.getMsgToolsList().then(function(b){a.msgTools=[];for(var c=4,d=[],e=0;e<b.data.length;e++)e%c===0&&0!==e&&(a.msgTools.push(d),d=[]),d.push(b.data[e]);d.length>0&&a.msgTools.push(d)}),a.handMsgTools=function(a,b){console.log("不支持类型:"+a.text)},a.startRecordVoice=function(){a.strart4Voice=new Date},a.sendMsg4Voice=function(){null!=a.strart4Voice&&(console.log("发送语音:"+((new Date).getTime()-a.strart4Voice.getTime())/1e3+"s"),a.strart4Voice=null)}}),app.run(function(a){a.emList={faceList:[]};for(var b="/imgs/face/",c=".gif",d=1,e=15,f=6,g=[],h=d;e+d>h;h++){var i={code:h,path:b+h+c};(h-d)%f===0&&h!==d&&(a.emList.faceList.push(g),g=[]),g.push(i)}g.length>0&&a.emList.faceList.push(g)}),app.run(function(a,b,c){a.testGetMessageRondom=function(){var b=Math.floor(9*Math.random()+1);c.getUserList().then(function(c){var d,e=c.data;angular.forEach(e,function(a){return String(a.id)===String(b)?void(d=a):void 0});var f={id:1,content:"测试-收到消息 ",time:(new Date).getTime(),sourceType:1,msgType:1};a.getMsg(d,f)})},a.testGetMessageWindow=function(){var b="#/talkWindow/";if(-1===window.location.hash.indexOf(b))return void console.log("不是聊天窗口");var d=Number(window.location.hash.substring(b.length));c.getUserList().then(function(b){var c,e=b.data;angular.forEach(e,function(a){return String(a.id)===String(d)?void(c=a):void 0});var f={id:1,content:"测试-收到消息 ",time:(new Date).getTime(),sourceType:1,msgType:1};a.getMsg(c,f)})}}),app.factory("popup",function(a){return{confim:function(b,c){return a.open({animation:!0,templateUrl:"/app/modules/base/htmls/confim.part.html",controller:function(a,d){a.title=b,a.msg=c,a.ok=function(){d.close("ok")},a.cancel=function(){d.dismiss("cancel")}}})}}}),app.config(function(a){a.defaults.headers.post["Content-Type"]="application/json;charset=utf-8"}),app.directive("weLayout",function(){return{restrict:"EA",templateUrl:"/app/modules/base/htmls/layout.part.html"}}),app.directive("weHeader",function(){return{restrict:"EA",replace:!0,templateUrl:"/app/modules/base/htmls/header.part.html"}}),app.directive("weFooter",function(){return{restrict:"EA",replace:!0,templateUrl:"/app/modules/base/htmls/footer.part.html"}}),app.directive("ngTouchstart",function(){return{controller:function(a,b,c){function d(c){var d=b.attr("ng-touchstart");a.$event=c,a.$apply(d)}b.bind("touchstart",d)}}}),app.directive("ngTouchmove",function(){return{controller:function(a,b,c){function d(a){a.preventDefault(),b.bind("touchmove",e),b.bind("touchend",f)}function e(c){var d=b.attr("ng-touchmove");a.$event=c,a.$apply(d)}function f(a){a.preventDefault(),b.unbind("touchmove",e),b.unbind("touchend",f)}b.bind("touchstart",d)}}}),app.directive("ngTouchend",function(){return{controller:function(a,b,c){function d(c){var d=b.attr("ng-touchend");a.$event=c,a.$apply(d)}b.bind("touchend",d)}}}),app.directive("focusable",function(){return{restrict:"A",scope:{focusable:"="},link:function(a,b,c){a.$watch("focusable",function(a){a&&setTimeout(function(){b[0].focus()},0)})}}}),app.filter("userStatusFilter",function(a){return function(b){var c=a.i18n.user,d=Number(b);return 0===d?c.statusNormal:1===d?c.statusFrozen:a.i18n["public"].unKnow}}),app.config(function(a){a.when("/userList",{templateUrl:"/app/modules/user/htmls/user_list.html",controller:"userListController"}).when("/talkList",{templateUrl:"/app/modules/talk/htmls/talk_list.html",controller:"talkListController"}).when("/talkWindow/:id",{templateUrl:"/app/modules/talk/htmls/talk_window.html",controller:"talkWindowController"}).otherwise({templateUrl:"/app/modules/base/htmls/unknow.part.html",controller:function(a,b){a.bodyClass="error-page"}})}),app.service("weService",function(a){return{getUserList:function(){return a({url:"/app/displaydata/userlist.json",method:"get",dataType:"json"})},getMsgToolsList:function(){return a({url:"/app/modules/base/data/messageTools.json",method:"get",dataType:"json"})}}}),app.service("localStorageService",function(a,b,c){return{getRecentTalkList:function(){var a=c.getObject("loginUser"),b=window.localStorage,d=[];if(b){var e=a.id+"_recent_users";d=b.getItem(e),d=null===d?[]:JSON.parse(d),angular.forEach(d,function(c){var d=a.id+"_history_"+c.userId,e=b.getItem(d);if(null!=e){e=JSON.parse(e);var f=e[0];c.lastMsgContent=f.content,c.lastMsgTime=f.time;for(var g=0,h=0;h<e.length;h++){var i=e[h];if(1===i.sourceType){if(i.isRead)break;g++}}c.noReadNum=g}})}else console.log("不支持本地存储");return d},getRecentMsgList:function(b,d,e){var f,g=c.getObject("loginUser"),h=window.localStorage;if(h){var i=g.id+"_history_"+b;f=h.getItem(i),f=null!==f?JSON.parse(f):[];for(var j=0;j<f.length;j++){var k=f[j];if(1!==k.sourceType||k.isRead){if(k.isRead)break}else k.isRead=!0,a.noreadNumTotal=a.noreadNumTotal-1}h.setItem(i,JSON.stringify(f)),f=f.slice((d-1)*e,d*e)}else console.log("不支持本地存储");return f},handlerReceiveMsg:function(b,d){var e=c.getObject("loginUser"),f=window.localStorage;if(f){var g=e.id+"_history_"+b.id,h=f.getItem(g);h=null===h?[]:JSON.parse(h),100===h.length&&h.pop();var i=a.isTalkingUser(b.id),j={id:d.id,content:d.content,time:(new Date).getTime(),status:0,sourceType:1,msgType:d.msgType,isRead:i};h.unshift(j),f.setItem(g,JSON.stringify(h))}else console.log("不支持本地存储")},handlerSendMsg:function(a,b){var d=c.getObject("loginUser"),e=window.localStorage;if(e){var f=d.id+"_history_"+a.id,g=e.getItem(f);g=null===g?[]:JSON.parse(g),g.unshift(b),e.setItem(f,JSON.stringify(g))}else console.log("不支持本地存储")},handlerRecentTalkList:function(a){var b=c.getObject("loginUser"),d=window.localStorage;if(d){var e=b.id+"_recent_users",f=d.getItem(e);f=null===f?[]:JSON.parse(f);for(var g=-1,h=0;h<f.length;h++){var i=f[h];if(String(i.userId)===String(a.id)){g=h;break}}g>0&&f.splice(g,1),0!==g&&f.unshift({userId:a.id,userName:a.name,userImgUrl:a.imgUrl}),d.setItem(e,JSON.stringify(f))}else console.log("不支持本地存储")},getNoreadNumTotal:function(){var a=0,b=c.getObject("loginUser"),d=window.localStorage,e=[];if(d){var f=b.id+"_recent_users";if(e=d.getItem(f),null===e)return a;e=JSON.parse(e),angular.forEach(e,function(c){var e=b.id+"_history_"+c.userId,f=d.getItem(e);if(null!=f){f=JSON.parse(f);var g=f[0];c.lastMsgContent=g.content,c.lastMsgTime=g.time;for(var h=0,i=0;i<f.length;i++){var j=f[i];if(1===j.sourceType){if(j.isRead)break;h++}}a+=h}})}else console.log("不支持本地存储");return a}}}),app.controller("talkListController",function(a,b,c,d){a.title="消息",b.getTalkList=function(){b.talkList=d.getRecentTalkList();var c=new Date;angular.forEach(b.talkList,function(a){var b=new Date(a.lastMsgTime);c.getFullYear()===b.getFullYear()&&c.getMonth()===b.getMonth()&&c.getDate()===b.getDate()&&(a.isToday=!0)}),a.refreshTalkList=!1},b.getTalkList(),b.talk=function(a){c.path("/talkWindow/"+a.userId)},a.$watch("refreshTalkList",function(a,c,d){a&&b.getTalkList()})}),app.controller("talkWindowController",function(a,b,c,d,e,f,g,h){var i=String(d.id);g.getUserList().then(function(c){angular.forEach(c.data,function(c){String(c.id)===i&&(b.userInfo=c,a.title=b.userInfo.name)})}),b.loginUser=e.getObject("loginUser"),b.pageNo=1,b.pageSize=3,a.talkingList=h.getRecentMsgList(i,b.pageNo,b.pageSize),b.sendMsg=function(){var c=$("#msgInput").val();if(c){b.sending=!0;var d={id:1,content:c,status:Math.random()>.5?0:1,time:(new Date).getTime(),sourceType:2,msgType:1};a.talkingList.push(d),$("#msgInput").val(null),h.handlerSendMsg(b.userInfo,d),h.handlerRecentTalkList(b.userInfo)}},a.sendMsgByKeyup=function(a){13===a.keyCode&&b.sendMsg()},a.sendMsgByButton=function(){a.msgInputFocus=!0,b.sendMsg()},a.focusInput=function(){a.msgInputFocus=!1,a.showTools=!1},b.$watch("talkingList",function(a,b,c){f(function(){$("section")[0].scrollTop=$("section")[0].scrollHeight})},!0)}),app.controller("userListController",function(a,b,c,d){a.title="通讯录",d.getUserList().then(function(a){b.userListOrg=a.data,b.userList=a.data,b.queryKeyList=[],angular.forEach(b.userList,function(a){var c=a.initial,d=!0;angular.forEach(b.queryKeyList,function(a){return a===c?void(d=!1):void 0}),d&&b.queryKeyList.push(c)})}),b.talk=function(a){c.path("/talkWindow/"+a.id)},b.queryByinitial=function(a){console.log(a)},b.queryByKey=function(){b.userList=[],angular.forEach(b.userListOrg,function(a){-1!==a.name.indexOf(b.queryData)&&b.userList.push(a)})},b.queryByKeyBLur=function(){b.userList=b.userListOrg,b.queryData=null},b.queryByKeyFocus=function(){b.userList=[]}});