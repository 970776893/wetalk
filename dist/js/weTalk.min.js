var dependencies=["ngAnimate","ngRoute","ngCookies","ngTouch"],app=angular.module("app",dependencies);app.run(function(a){var b={id:1e4,name:"张凯",imgUrl:"/app/displaydata/imgs/zhangkai.png"};a.putObject("loginUser",b)}),app.run(function(a,b){}),app.factory("popup",function(a){return{confim:function(b,c){return a.open({animation:!0,templateUrl:"/app/modules/base/htmls/confim.part.html",controller:function(a,d){a.title=b,a.msg=c,a.ok=function(){d.close("ok")},a.cancel=function(){d.dismiss("cancel")}}})}}}),app.config(function(a){a.defaults.headers.post["Content-Type"]="application/json;charset=utf-8"}),app.directive("weLayout",function(){return{restrict:"EA",templateUrl:"/app/modules/base/htmls/layout.part.html",controller:function(a,b,c){b.$on("$locationChangeSuccess",function(a,d,e){b.url=c.$$url;var f="we-"+d.substring(d.indexOf("#")+2).toLocaleLowerCase();if(f.indexOf("/")>0&&(f=f.substring(0,f.indexOf("/"))),$("body").addClass(f),d!==e){var g="we-"+e.substring(e.indexOf("#")+2).toLocaleLowerCase();g.indexOf("/")>0&&(g=g.substring(0,g.indexOf("/"))),$("body").removeClass(g)}})}}}),app.directive("ngTouchstart",function(){return{controller:function(a,b,c){function d(c){var d=b.attr("ng-touchstart");a.$event=c,a.$apply(d)}b.bind("touchstart",d)}}}),app.directive("ngTouchmove",function(){return{controller:function(a,b,c){function d(a){a.preventDefault(),b.bind("touchmove",e),b.bind("touchend",f)}function e(c){var d=b.attr("ng-touchmove");a.$event=c,a.$apply(d)}function f(a){a.preventDefault(),b.unbind("touchmove",e),b.unbind("touchend",f)}b.bind("touchstart",d)}}}),app.directive("ngTouchend",function(){return{controller:function(a,b,c){function d(c){var d=b.attr("ng-touchend");a.$event=c,a.$apply(d)}b.bind("touchend",d)}}}),app.filter("userStatusFilter",function(a){return function(b){var c=a.i18n.user,d=Number(b);return 0===d?c.statusNormal:1===d?c.statusFrozen:a.i18n["public"].unKnow}}),app.config(function(a){a.when("/userList",{templateUrl:"/app/modules/user/htmls/user_list.html",controller:"userListController"}).when("/talkList",{templateUrl:"/app/modules/talk/htmls/talk_list.html",controller:"talkListController"}).when("/talkWindow/:id",{templateUrl:"/app/modules/talk/htmls/talk_window.html",controller:"talkWindowController"}).otherwise({templateUrl:"/app/modules/base/htmls/unknow.part.html"})}),app.service("weService",function(a){return{getUserList:function(){return a({url:"/app/displaydata/userlist.json",method:"get",dataType:"json"})}}}),app.service("localStorageService",function(a,b){return{getRecentTalkList:function(){var a=b.getObject("loginUser"),c=window.localStorage,d=[];if(c){var e=a.id+"_recent_users";d=c.getItem(e),d=null===d?[]:JSON.parse(d),angular.forEach(d,function(b){var d=a.id+"_history_"+b.userId,e=c.getItem(d);if(null!=e){e=JSON.parse(e);var f=e[e.length-1];b.lastMsgContent=f.content,b.lastMsgTime=f.time;for(var g=0,h=0;h<e.length;h++){var i=e[h];if(1===i.sourceType){if(i.isRead)break;g++}}b.noReadNum=g}})}else console.log("不支持本地存储");return d},getRecentMsgList:function(a){var c,d=b.getObject("loginUser"),e=window.localStorage;if(e){var f=d.id+"_history_"+a;c=e.getItem(f),c=null!==c?JSON.parse(c):[];for(var g=0;g<c.length;g++){var h=c[g];1===h.sourceType&&(h.isRead=!0)}e.setItem(f,JSON.stringify(c))}else console.log("不支持本地存储");return c},handlerReceiveMsg:function(a,c,d,e,f){var g=b.getObject("loginUser"),h=window.localStorage;if(h){var i=g.id+"_history_"+a,j=h.getItem(i);j=null===j?[]:JSON.parse(j),100===j.length&&j.pop();var k="#/talkWindow/",l=!1;if(-1!==window.location.hash.indexOf(k)){var m=Number(window.location.hash.substring(k.length));a===m&&(l=!0)}j.push({id:f,content:e,time:(new Date).getTime(),sourceType:1,msgType:1,isRead:l}),h.setItem(i,JSON.stringify(j))}else console.log("不支持本地存储")},handlerSendMsg:function(a,c,d,e,f){var g=b.getObject("loginUser"),h=window.localStorage;if(h){var i=g.id+"_history_"+a,j=h.getItem(i);j=null===j?[]:JSON.parse(j),j.push({id:f,content:e,time:(new Date).getTime(),sourceType:2,msgType:1}),h.setItem(i,JSON.stringify(j))}else console.log("不支持本地存储")},handlerRecentTalkList:function(a,c,d){var e=b.getObject("loginUser"),f=window.localStorage;if(f){var g=e.id+"_recent_users",h=f.getItem(g);h=null===h?[]:JSON.parse(h);for(var i=-1,j=0;j<h.length;j++){var k=h[j];if(String(k.userId)===String(a)){i=j;break}}i>0&&h.splice(i,1),0!==i&&h.unshift({userId:a,userName:c,userImgUrl:d}),f.setItem(g,JSON.stringify(h))}else console.log("不支持本地存储")}}}),app.controller("talkListController",function(a,b,c,d){b.talkList=d.getRecentTalkList();var e=new Date;angular.forEach(b.talkList,function(a){var b=new Date(a.lastMsgTime);e.getFullYear()===b.getFullYear()&&e.getMonth()===b.getMonth()&&e.getDate()===b.getDate()&&(a.isToday=!0)}),b.talk=function(a){console.log(a),c.path("/talkWindow/"+a.userId)}}),app.controller("talkWindowController",function(a,b,c,d,e,f,g){var h=String(d.id);f.getUserList().then(function(a){angular.forEach(a.data,function(a){String(a.id)===h&&(b.userInfo=a)})}),b.loginUser=e.getObject("loginUser"),a.talkingList=g.getRecentMsgList(h),b.getMsg=function(){var c="我收到你得消息了。-测试";if(c){b.sending=!0,a.talkingList.push({id:1,content:c,sourceType:1});g.handlerReceiveMsg(b.userInfo.id,b.userInfo.name,b.userInfo.imgUrl,c),g.handlerRecentTalkList(b.userInfo.id,b.userInfo.name,b.userInfo.imgUrl),b.$apply(),$(document).scrollTop(1e8)}},b.sendMsg=function(){var c=$("#msgInput").val();if(c){b.sending=!0,a.talkingList.push({id:1,content:c,sourceType:2}),$(document).scrollTop(1e8),$("#msgInput").val(null);var d=1;g.handlerSendMsg(b.userInfo.id,b.userInfo.name,b.userInfo.imgUrl,c,d),g.handlerRecentTalkList(b.userInfo.id,b.userInfo.name,b.userInfo.imgUrl)}},$(window).scroll(function(){var a=$(window).scrollTop();0===a&&(b.showLoading=!0,console.log(b.showLoading))}),a.sendMsgByKeyup=function(a){13===a.keyCode&&b.sendMsg()},a.sendMsgByButton=function(){b.sendMsg()}}),app.controller("userListController",function(a,b,c,d){d.getUserList().then(function(a){b.userListOrg=a.data,b.userList=a.data,b.queryKeyList=[],angular.forEach(b.userList,function(a){var c=a.initial,d=!0;angular.forEach(b.queryKeyList,function(a){return a===c?void(d=!1):void 0}),d&&b.queryKeyList.push(c)})}),b.talk=function(a){c.path("/talkWindow/"+a.id)},b.queryByinitial=function(a){console.log(a)},b.queryByKey=function(){b.userList=[],angular.forEach(b.userListOrg,function(a){-1!==a.name.indexOf(b.queryData)&&b.userList.push(a)})},b.queryByKeyBLur=function(){b.userList=b.userListOrg,b.queryData=null},b.queryByKeyFocus=function(){b.userList=[]}});